---

- name: "time: install packages"
  apt:
    name:
    - ntpdate
    install_recommends: false
    update_cache: true
    autoclean: true
    autoremove: true
  register: apt_install_time
  retries: 5
  until: apt_install_time is success


- name: "time: set timezone"
  timezone:
    name: "{{ timezone | default('America/New_York') }}"
  notify: systemd-timesyncd configuration changed

- name: "time: copy timesyncd config"
  copy:
    content: |
      [Time]
      NTP={{ ntp_servers.primary | default("") | join(" ") }}
      FallbackNTP={{ ntp_servers.fallback | join(" ") }}
    dest: /etc/systemd/timesyncd.conf
  notify: systemd-timesyncd configuration changed

- name: "time: start systemd service"
  systemd:
    name: systemd-timesyncd
    enabled: true
    state: started

- name: "time: run timedatectl status"
  command: /usr/bin/timedatectl show
  changed_when: false
  check_mode: false
  register: timedatectl_result

- name: "time: enable ntp"
  command: /usr/bin/timedatectl set-ntp true
  when: "'NTP=no' in timedatectl_result.stdout"